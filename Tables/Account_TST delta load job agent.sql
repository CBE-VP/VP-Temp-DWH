--Connect to the job database specified when creating the job agent

-- Delete job
--EXEC jobs.sp_delete_job @job_name='AgentJob_Account_DeltaLoad';

--Add job for updating table with new or changed rows
EXEC jobs.sp_add_job @job_name='AgentJob_Account_DeltaLoad'
GO

-- Add job step for updating table with new or changed rows
EXEC jobs.sp_add_jobstep @job_name='AgentJob_Account_DeltaLoad',
@command=N'
INSERT INTO account_archive
SELECT 
[Id]
      ,[SinkCreatedOn]
      ,[SinkModifiedOn]
      ,[statecode]
      ,[statuscode]
      ,[accountratingcode]
      ,[address1_addresstypecode]
      ,[vp_imagemodalities]
      ,[preferredappointmentdaycode]
      ,[vp_pacsintegration]
      ,[address1_shippingmethodcode]
      ,[vp_smscategory]
      ,[accountcategorycode]
      ,[vp_softwareuse]
      ,[vp_vnaintegration]
      ,[address1_freighttermscode]
      ,[vp_imsintegration]
      ,[preferredappointmenttimecode]
      ,[accountclassificationcode]
      ,[customersizecode]
      ,[ownershipcode]
      ,[address2_freighttermscode]
      ,[preferredcontactmethodcode]
      ,[industrycode]
      ,[shippingmethodcode]
      ,[paymenttermscode]
      ,[businesstypecode]
      ,[address2_addresstypecode]
      ,[customertypecode]
      ,[vp_profonlinesupportbalance]
      ,[address2_shippingmethodcode]
      ,[vp_lisintegration]
      ,[territorycode]
      ,[donotpostalmail]
      ,[vp_ivdcustomer]
      ,[creditonhold]
      ,[donotbulkpostalmail]
      ,[vp_ivdapp]
      ,[donotbulkemail]
      ,[donotfax]
      ,[vp_ishms]
      ,[donotemail]
      ,[followemail]
      ,[participatesinworkflow]
      ,[vp_taxexempt]
      ,[marketingonly]
      ,[isprivate]
      ,[merged]
      ,[donotphone]
      ,[donotsendmm]
      ,[vp_ivdscanner]
      ,[vp_synctohubspot]
      ,[msa_managingpartnerid]
      ,[msa_managingpartnerid_entitytype]
      ,[slainvokedid]
      ,[slainvokedid_entitytype]
      ,[createdonbehalfby]
      ,[createdonbehalfby_entitytype]
      ,[originatingleadid]
      ,[originatingleadid_entitytype]
      ,[vp_address1_countryid]
      ,[vp_address1_countryid_entitytype]
      ,[territoryid]
      ,[territoryid_entitytype]
      ,[slaid]
      ,[slaid_entitytype]
      ,[parentaccountid]
      ,[parentaccountid_entitytype]
      ,[primarycontactid]
      ,[primarycontactid_entitytype]
      ,[preferredequipmentid]
      ,[preferredequipmentid_entitytype]
      ,[owningbusinessunit]
      ,[owningbusinessunit_entitytype]
      ,[owningteam]
      ,[owningteam_entitytype]
      ,[vp_owningdistributoraccountid]
      ,[vp_owningdistributoraccountid_entitytype]
      ,[modifiedonbehalfby]
      ,[modifiedonbehalfby_entitytype]
      ,[owninguser]
      ,[owninguser_entitytype]
      ,[modifiedby]
      ,[modifiedby_entitytype]
      ,[vp_companysubtypeid]
      ,[vp_companysubtypeid_entitytype]
      ,[transactioncurrencyid]
      ,[transactioncurrencyid_entitytype]
      ,[vp_address2_countryid]
      ,[vp_address2_countryid_entitytype]
      ,[modifiedbyexternalparty]
      ,[modifiedbyexternalparty_entitytype]
      ,[masterid]
      ,[masterid_entitytype]
      ,[defaultpricelevelid]
      ,[defaultpricelevelid_entitytype]
      ,[createdby]
      ,[createdby_entitytype]
      ,[createdbyexternalparty]
      ,[createdbyexternalparty_entitytype]
      ,[preferredserviceid]
      ,[preferredserviceid_entitytype]
      ,[preferredsystemuserid]
      ,[preferredsystemuserid_entitytype]
      ,[vp_companytypeid]
      ,[vp_companytypeid_entitytype]
      ,[ownerid]
      ,[ownerid_entitytype]
      ,[aging90]
      ,[openrevenue]
      ,[aging30]
      ,[marketcap]
      ,[aging60_base]
      ,[vp_smscost_base]
      ,[creditlimit]
      ,[openrevenue_base]
      ,[creditlimit_base]
      ,[aging60]
      ,[aging30_base]
      ,[revenue]
      ,[revenue_base]
      ,[vp_smscost]
      ,[aging90_base]
      ,[marketcap_base]
      ,[emailaddress3]
      ,[emailaddress2]
      ,[emailaddress1]
      ,[masteraccountidyominame]
      ,[address1_city]
      ,[vp_supportremaining]
      ,[address1_line1]
      ,[adx_createdbyipaddress]
      ,[modifiedon]
      ,[vp_customercenteraccountlogin]
      ,[websiteurl]
      ,[address1_longitude]
      ,[entityimage_timestamp]
      ,[vp_companysubtypeidname]
      ,[sharesoutstanding]
      ,[adx_modifiedbyusername]
      ,[primarycontactidname]
      ,[transactioncurrencyidname]
      ,[preferredsystemuseridyominame]
      ,[telephone1]
      ,[opendeals_date]
      ,[modifiedbyexternalpartyyominame]
      ,[masteraccountidname]
      ,[preferredsystemuseridname]
      ,[address2_stateorprovince]
      ,[address2_line2]
      ,[vp_customercenteraccountname]
      ,[address1_line3]
      ,[name]
      ,[onholdtime]
      ,[parentaccountidname]
      ,[originatingleadidname]
      ,[address1_utcoffset]
      ,[numberofemployees]
      ,[modifiedbyexternalpartyname]
      ,[address1_telephone1]
      ,[vp_owningdistributoraccountidname]
      ,[exchangerate]
      ,[address2_county]
      ,[vp_bedrockwakeup]
      ,[telephone3]
      ,[fax]
      ,[address2_city]
      ,[vp_trainingcomments]
      ,[address2_latitude]
      ,[createdon]
      ,[vp_sharepointnumber]
      ,[timespentbymeonemailandmeetings]
      ,[address1_composite]
      ,[opendeals_state]
      ,[address2_postalcode]
      ,[lastusedincampaign]
      ,[accountnumber]
      ,[owneridyominame]
      ,[entityimage_url]
      ,[teamsfollowed]
      ,[address2_line3]
      ,[description]
      ,[vp_smsexpiry]
      ,[timezoneruleversionnumber]
      ,[address1_county]
      ,[createdbyname]
      ,[vp_onsitetrainingdays]
      ,[address2_postofficebox]
      ,[address2_telephone1]
      ,[address2_telephone2]
      ,[address2_telephone3]
      ,[originatingleadidyominame]
      ,[adx_createdbyusername]
      ,[address1_addressid]
      ,[traversedpath]
      ,[territoryidname]
      ,[yominame]
      ,[createdonbehalfbyname]
      ,[address2_name]
      ,[openrevenue_state]
      ,[address1_country]
      ,[primarysatoriid]
      ,[owneridtype]
      ,[entityimageid]
      ,[adx_modifiedbyipaddress]
      ,[primarytwitterid]
      ,[owneridname]
      ,[modifiedonbehalfbyname]
      ,[overriddencreatedon]
      ,[address2_composite]
      ,[address1_stateorprovince]
      ,[msa_managingpartneridname]
      ,[preferredserviceidname]
      ,[accountid]
      ,[vp_trainingbalance]
      ,[vp_department]
      ,[createdbyexternalpartyyominame]
      ,[vp_swversion]
      ,[vp_crmurllink]
      ,[address1_telephone2]
      ,[address1_telephone3]
      ,[address1_postofficebox]
      ,[createdonbehalfbyyominame]
      ,[slainvokedidname]
      ,[address2_country]
      ,[sic]
      ,[vp_vatno]
      ,[address2_utcoffset]
      ,[vp_eanno]
      ,[address2_fax]
      ,[address2_longitude]
      ,[vp_owningdistributoraccountidyominame]
      ,[ftpsiteurl]
      ,[preferredequipmentidname]
      ,[address1_primarycontactname]
      ,[modifiedbyyominame]
      ,[lastonholdtime]
      ,[address1_line2]
      ,[openrevenue_date]
      ,[address2_upszone]
      ,[vp_address1_countryidname]
      ,[address1_postalcode]
      ,[tickersymbol]
      ,[stageid]
      ,[utcconversiontimezonecode]
      ,[createdbyexternalpartyname]
      ,[vp_address2_countryidname]
      ,[defaultpricelevelidname]
      ,[msa_managingpartneridyominame]
      ,[stockexchange]
      ,[address2_addressid]
      ,[vp_smscomment]
      ,[telephone2]
      ,[importsequencenumber]
      ,[versionnumber]
      ,[vp_academytrainings]
      ,[address1_name]
      ,[address1_fax]
      ,[address1_latitude]
      ,[primarycontactidyominame]
      ,[vp_companytypeidname]
      ,[modifiedbyname]
      ,[createdbyyominame]
      ,[address2_line1]
      ,[address1_upszone]
      ,[modifiedonbehalfbyyominame]
      ,[slaname]
      ,[processid]
      ,[parentaccountidyominame]
      ,[address2_primarycontactname]
      ,[opendeals]
	  , CAST(GETDATE() as date) [LoadDate]
FROM   account
WHERE  Datediff(wk, Getdate(), modifiedon) = 0
       AND Year(modifiedon) = Year(Getdate()) 
;',
@credential_name='job_execution',
@target_group_name='d365Group'

/* Schedule job execution*/	
EXEC jobs.sp_update_job
@job_name='AgentJob_Account_DeltaLoad',
@enabled=1,
@schedule_interval_type='Weeks',
@schedule_interval_count=1,
@schedule_start_time = '20211025 20:00'

