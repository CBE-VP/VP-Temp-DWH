


-- Delete job
EXEC jobs.sp_delete_job @job_name='AgentJob_opportunity_DeltaLoad'
GO
EXEC jobs.sp_add_job @job_name='AgentJob_opportunity_DeltaLoad'
GO
-- Add job step for updating table with new or changed rows
EXEC jobs.sp_add_jobstep @job_name='AgentJob_opportunity_DeltaLoad',
@command=N'
INSERT INTO opportunity_archive
SELECT 
[Id]
      ,[SinkCreatedOn]
      ,[SinkModifiedOn]
      ,[statecode]
      ,[statuscode]
      ,[vp_sowagreed]
      ,[vp_productfocus]
      ,[vp_sowissued]
      ,[vp_partnersource]
      ,[initialcommunication]
      ,[vp_distributor]
      ,[purchasetimeframe]
      ,[vp_source]
      ,[vp_development]
      ,[opportunityratingcode]
      ,[salesstage]
      ,[vp_funnelstatus]
      ,[vp_estimateofeffortagreed]
      ,[vp_projectquestionnairereceived]
      ,[vp_projectquestionnairesent]
      ,[vp_originofopportunity]
      ,[vp_ordertype]
      ,[vp_salestype]
      ,[skippricecalculation]
      ,[vp_estimateofeffortsent]
      ,[timeline]
      ,[msdyn_forecastcategory]
      ,[budgetstatus]
      ,[pricingerrorcode]
      ,[prioritycode]
      ,[vp_opportunitysegment]
      ,[purchaseprocess]
      ,[salesstagecode]
      ,[need]
      ,[vp_pmfocus]
      ,[vp_applicationsegment]
      ,[presentfinalproposal]
      ,[completeinternalreview]
      ,[developproposal]
      ,[isrevenuesystemcalculated]
      ,[confirminterest]
      ,[presentproposal]
      ,[completefinalproposal]
      ,[identifypursuitteam]
      ,[pursuitdecision]
      ,[vp_pocplanagreed]
      ,[sendthankyounote]
      ,[identifycompetitors]
      ,[evaluatefit]
      ,[filedebrief]
      ,[vp_verbalapprovalreceived]
      ,[vp_3rdpartyitemsincluded]
      ,[captureproposalfeedback]
      ,[participatesinworkflow]
      ,[decisionmaker]
      ,[vp_bidmanagementinvolvement]
      ,[isprivate]
      ,[resolvefeedback]
      ,[identifycustomercontacts]
      ,[vp_painadmitted]
      ,[vp_synctohubspot]
      ,[contactid]
      ,[contactid_entitytype]
      ,[slaid]
      ,[slaid_entitytype]
      ,[accountid]
      ,[accountid_entitytype]
      ,[vp_territoryid]
      ,[vp_territoryid_entitytype]
      ,[owningbusinessunit]
      ,[owningbusinessunit_entitytype]
      ,[parentcontactid]
      ,[parentcontactid_entitytype]
      ,[parentaccountid]
      ,[parentaccountid_entitytype]
      ,[pricelevelid]
      ,[pricelevelid_entitytype]
      ,[modifiedby]
      ,[modifiedby_entitytype]
      ,[owningteam]
      ,[owningteam_entitytype]
      ,[owninguser]
      ,[owninguser_entitytype]
      ,[slainvokedid]
      ,[slainvokedid_entitytype]
      ,[vp_createdbyid]
      ,[vp_createdbyid_entitytype]
      ,[createdonbehalfby]
      ,[createdonbehalfby_entitytype]
      ,[transactioncurrencyid]
      ,[transactioncurrencyid_entitytype]
      ,[modifiedonbehalfby]
      ,[modifiedonbehalfby_entitytype]
      ,[campaignid]
      ,[campaignid_entitytype]
      ,[originatingleadid]
      ,[originatingleadid_entitytype]
      ,[createdby]
      ,[createdby_entitytype]
      ,[msa_partneroppid]
      ,[msa_partneroppid_entitytype]
      ,[msa_partnerid]
      ,[msa_partnerid_entitytype]
      ,[ownerid]
      ,[ownerid_entitytype]
      ,[customerid]
      ,[customerid_entitytype]
      ,[budgetamount_base]
      ,[vp_bonusvalue]
      ,[vp_bonusvaluetechsales_base]
      ,[freightamount]
      ,[totaltax]
      ,[discountamount_base]
      ,[vp_bonusvaluetechsales]
      ,[totallineitemamount_base]
      ,[vp_grossprofit_base]
      ,[vp_servicevalue]
      ,[vp_bonusvalue_base]
      ,[totaldiscountamount]
      ,[freightamount_base]
      ,[estimatedvalue]
      ,[actualvalue_base]
      ,[totalamountlessfreight_base]
      ,[totalamountlessfreight]
      ,[totallineitemamount]
      ,[vp_servicevalue_base]
      ,[actualvalue]
      ,[vp_bonusvalueremaining_base]
      ,[vp_firstyearsubscriptionvalue_base]
      ,[vp_grossprofit]
      ,[totallineitemdiscountamount_base]
      ,[budgetamount]
      ,[estimatedvalue_base]
      ,[totaldiscountamount_base]
      ,[totallineitemdiscountamount]
      ,[totalamount]
      ,[totalamount_base]
      ,[vp_bonusvalueremaining]
      ,[discountamount]
      ,[totaltax_base]
      ,[vp_firstyearsubscriptionvalue]
      ,[finaldecisiondate]
      ,[modifiedon]
      ,[contactidname]
      ,[transactioncurrencyidname]
      ,[campaignidname]
      ,[vp_salessupportperc]
      ,[vp_statuslastmodifiedby]
      ,[vp_commentopportunity]
      ,[customerpainpoints]
      ,[quotecomments]
      ,[msa_partneridname]
      ,[vp_statuslastmodifiedon]
      ,[owneridyominame]
      ,[customerneed]
      ,[estimatedclosedate]
      ,[parentaccountidname]
      ,[originatingleadidname]
      ,[versionnumber]
      ,[contactidyominame]
      ,[name]
      ,[parentaccountidyominame]
      ,[exchangerate]
      ,[vp_bedrockwakeup]
      ,[proposedsolution]
      ,[createdon]
      ,[vp_sharepointnumber]
      ,[vp_laststagechange_date]
      ,[customeridyominame]
      ,[actualclosedate]
      ,[qualificationcomments]
      ,[customeridtype]
      ,[vp_opportunityidnumber]
      ,[onholdtime]
      ,[processid]
      ,[teamsfollowed]
      ,[description]
      ,[timezoneruleversionnumber]
      ,[stepname]
      ,[accountidname]
      ,[vp_createdbyidname]
      ,[originatingleadidyominame]
      ,[traversedpath]
      ,[vp_lastactivity]
      ,[vp_close_date]
      ,[msa_partneroppidname]
      ,[schedulefollowup_qualify]
      ,[owneridtype]
      ,[msa_partneroppidyominame]
      ,[timespentbymeonemailandmeetings]
      ,[modifiedonbehalfbyname]
      ,[overriddencreatedon]
      ,[vp_lastactivity_date]
      ,[msa_partneridyominame]
      ,[opportunityid]
      ,[vp_jiraid]
      ,[createdonbehalfbyname]
      ,[vp_calculatedprobability]
      ,[emailaddress]
      ,[vp_createdbyidyominame]
      ,[vp_sourcecomment]
      ,[parentcontactidyominame]
      ,[slainvokedidname]
      ,[accountidyominame]
      ,[scheduleproposalmeeting]
      ,[vp_laststagechange]
      ,[stepid]
      ,[createdbyname]
      ,[vp_lastactivitytype]
      ,[modifiedbyyominame]
      ,[lastonholdtime]
      ,[schedulefollowup_prospect]
      ,[modifiedonbehalfbyyominame]
      ,[vp_recycledate]
      ,[stageid]
      ,[utcconversiontimezonecode]
      ,[vp_territoryidname]
      ,[customeridname]
      ,[importsequencenumber]
      ,[createdonbehalfbyyominame]
      ,[vp_lastactivity_state]
      ,[vp_laststagechange_state]
      ,[pricelevelidname]
      ,[parentcontactidname]
      ,[modifiedbyname]
      ,[createdbyyominame]
      ,[owneridname]
      ,[slaname]
      ,[closeprobability]
      ,[discountpercentage]
      ,[currentsituation]
        , CAST(GETDATE() as date) [LoadDate]
        ,[vp_presentproposal]
,[vp_competitive]
,[vp_convertquotationcreateorder] 
,[vp_accountdepartmentid]     
,[vp_accountdepartmentid_entitytype]      
,[vp_mergedopportunityid]     
,[vp_mergedopportunityid_entitytype]      
,[vp_weightedfunnelgpvalue]   
,[vp_weightedfunnelgpvalue_base]    
,[vp_nextsteps]   
,[vp_accountdepartmentidname] 
,[vp_mergedopportunityidname] 
,[vp_lostreasondetails] 
FROM opportunity
WHERE DATEDIFF(wk,getdate(),modifiedon) = 0
AND YEAR(modifiedon) = YEAR(GETDATE())
;',
@credential_name='job_execution',
@target_group_name='d365Group'
/* Schedule job execution*/   
EXEC jobs.sp_update_job
@job_name='AgentJob_opportunity_DeltaLoad',
@enabled=1,
@schedule_interval_type='Weeks',
@schedule_interval_count=1,
@schedule_start_time = '20211016 20:00'