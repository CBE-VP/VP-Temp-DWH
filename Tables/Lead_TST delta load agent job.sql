
-- Delete job
EXEC jobs.sp_delete_job @job_name='AgentJob_Lead_DeltaLoad'
GO

EXEC jobs.sp_add_job @job_name='AgentJob_Lead_DeltaLoad'
GO
-- Add job step for updating table with new or changed rows
EXEC jobs.sp_add_jobstep @job_name='AgentJob_Lead_DeltaLoad',
@command=N'
INSERT INTO lead_archive
SELECT 
[Id]
      ,[SinkCreatedOn]
      ,[SinkModifiedOn]
      ,[statecode]
      ,[statuscode]
      ,[address1_shippingmethodcode]
      ,[leadqualitycode]
      ,[industrycode]
      ,[leadsourcecode]
      ,[address2_shippingmethodcode]
      ,[vp_originofopportunity]
      ,[budgetstatus]
      ,[purchaseprocess]
      ,[purchasetimeframe]
      ,[need]
      ,[vp_salutationoption]
      ,[vp_source]
      ,[salesstage]
      ,[vp_leadsegment]
      ,[preferredcontactmethodcode]
      ,[prioritycode]
      ,[salesstagecode]
      ,[vp_jobfunction]
      ,[address2_addresstypecode]
      ,[address1_addresstypecode]
      ,[initialcommunication]
      ,[confirminterest]
      ,[vp_synctohubspot]
      ,[decisionmaker]
      ,[vp_mqlreached]
      ,[donotpostalmail]
      ,[evaluatefit]
      ,[donotbulkemail]
      ,[donotphone]
      ,[msdyn_gdproptout]
      ,[donotsendmm]
      ,[isprivate]
      ,[isautocreate]
      ,[merged]
      ,[donotfax]
      ,[donotemail]
      ,[followemail]
      ,[participatesinworkflow]
      ,[vp_hubspotunsubscribedfromallemail]
      ,[modifiedby]
      ,[modifiedby_entitytype]
      ,[relatedobjectid]
      ,[relatedobjectid_entitytype]
      ,[parentcontactid]
      ,[parentcontactid_entitytype]
      ,[vp_companysubtypeid]
      ,[vp_companysubtypeid_entitytype]
      ,[vp_address1_countryid]
      ,[vp_address1_countryid_entitytype]
      ,[transactioncurrencyid]
      ,[transactioncurrencyid_entitytype]
      ,[slainvokedid]
      ,[slainvokedid_entitytype]
      ,[accountid]
      ,[accountid_entitytype]
      ,[originatingcaseid]
      ,[originatingcaseid_entitytype]
      ,[owninguser]
      ,[owninguser_entitytype]
      ,[modifiedonbehalfby]
      ,[modifiedonbehalfby_entitytype]
      ,[createdonbehalfby]
      ,[createdonbehalfby_entitytype]
      ,[vp_companytypeid]
      ,[vp_companytypeid_entitytype]
      ,[parentaccountid]
      ,[parentaccountid_entitytype]
      ,[slaid]
      ,[slaid_entitytype]
      ,[qualifyingopportunityid]
      ,[qualifyingopportunityid_entitytype]
      ,[masterid]
      ,[masterid_entitytype]
      ,[owningbusinessunit]
      ,[owningbusinessunit_entitytype]
      ,[contactid]
      ,[contactid_entitytype]
      ,[owningteam]
      ,[owningteam_entitytype]
      ,[campaignid]
      ,[campaignid_entitytype]
      ,[vp_address2_countryid]
      ,[vp_address2_countryid_entitytype]
      ,[createdby]
      ,[createdby_entitytype]
      ,[ownerid]
      ,[ownerid_entitytype]
      ,[customerid]
      ,[customerid_entitytype]
      ,[revenue]
      ,[estimatedamount]
      ,[revenue_base]
      ,[budgetamount_base]
      ,[budgetamount]
      ,[estimatedamount_base]
      ,[address2_postalcode]
      ,[relatedobjectidname]
      ,[vp_hubspotleadsource]
      ,[pager]
      ,[address1_county]
      ,[overriddencreatedon]
      ,[qualifyingopportunityidname]
      ,[entityimageid]
      ,[address2_longitude]
      ,[address2_line3]
      ,[middlename]
      ,[transactioncurrencyidname]
      ,[address1_upszone]
      ,[processid]
      ,[leadid]
      ,[address1_stateorprovince]
      ,[fullname]
      ,[emailaddress2]
      ,[emailaddress1]
      ,[owneridyominame]
      ,[vp_bedrockwakeup]
      ,[yomicompanyname]
      ,[exchangerate]
      ,[estimatedvalue]
      ,[parentcontactidname]
      ,[address1_line2]
      ,[vp_leadscore_hubspot]
      ,[jobtitle]
      ,[address1_postofficebox]
      ,[numberofemployees]
      ,[address1_utcoffset]
      ,[address2_stateorprovince]
      ,[telephone1]
      ,[firstname]
      ,[modifiedon]
      ,[customeridyominame]
      ,[createdon]
      ,[yomimiddlename]
      ,[yomilastname]
      ,[subject]
      ,[schedulefollowup_prospect]
      ,[address2_utcoffset]
      ,[modifiedbyyominame]
      ,[parentaccountidyominame]
      ,[yomifullname]
      ,[modifiedbyname]
      ,[contactidyominame]
      ,[businesscardattributes]
      ,[salutation]
      ,[entityimage_url]
      ,[address2_country]
      ,[websiteurl]
      ,[vp_leadsourcedescription]
      ,[address2_line2]
      ,[vp_companytypeidname]
      ,[address2_fax]
      ,[address1_city]
      ,[fax]
      ,[timezoneruleversionnumber]
      ,[createdonbehalfbyyominame]
      ,[masterleadidyominame]
      ,[contactidname]
      ,[vp_address2_countryidname]
      ,[address2_composite]
      ,[owneridtype]
      ,[address1_name]
      ,[address1_postalcode]
      ,[parentaccountidname]
      ,[schedulefollowup_qualify]
      ,[qualificationcomments]
      ,[campaignidname]
      ,[mobilephone]
      ,[entityimage_timestamp]
      ,[address2_name]
      ,[emailaddress3]
      ,[address1_latitude]
      ,[yomifirstname]
      ,[masterleadidname]
      ,[teamsfollowed]
      ,[versionnumber]
      ,[address1_country]
      ,[telephone2]
      ,[lastusedincampaign]
      ,[address1_line3]
      ,[vp_becamemqldate]
      ,[lastname]
      ,[timespentbymeonemailandmeetings]
      ,[createdonbehalfbyname]
      ,[estimatedclosedate]
      ,[address2_postofficebox]
      ,[parentcontactidyominame]
      ,[vp_hubspottimelinelink]
      ,[accountidname]
      ,[vp_sharepointnumber]
      ,[slaname]
      ,[address1_composite]
      ,[sic]
      ,[address2_line1]
      ,[lastonholdtime]
      ,[modifiedonbehalfbyname]
      ,[address1_telephone2]
      ,[address1_telephone3]
      ,[description]
      ,[stageid]
      ,[originatingcaseidname]
      ,[address1_longitude]
      ,[utcconversiontimezonecode]
      ,[address1_telephone1]
      ,[address1_addressid]
      ,[address2_city]
      ,[address2_latitude]
      ,[traversedpath]
      ,[address2_addressid]
      ,[onholdtime]
      ,[address1_line1]
      ,[businesscard]
      ,[companyname]
      ,[createdbyyominame]
      ,[owneridname]
      ,[address2_telephone1]
      ,[address2_telephone2]
      ,[address2_telephone3]
      ,[customeridname]
      ,[vp_companysubtypeidname]
      ,[customeridtype]
      ,[createdbyname]
      ,[slainvokedidname]
      ,[vp_sourcecomments]
      ,[address2_upszone]
      ,[accountidyominame]
      ,[vp_address1_countryidname]
      ,[modifiedonbehalfbyyominame]
      ,[address1_fax]
      ,[importsequencenumber]
      ,[vp_recentconversion_hubspot]
      ,[telephone3]
      ,[address2_county]
      ,[vp_mqlreachedchangeddate]
	  , CAST(GETDATE() as date) [LoadDate]
	FROM Lead
WHERE DATEDIFF(wk,getdate(),modifiedon) = 0
AND YEAR(modifiedon) = YEAR(GETDATE())
;',
@credential_name='job_execution',
@target_group_name='d365Group'

/* Schedule job execution*/	
EXEC jobs.sp_update_job
@job_name='AgentJob_Lead_DeltaLoad',
@enabled=1,
@schedule_interval_type='Weeks',
@schedule_interval_count=1,
@schedule_start_time = '20211002 20:00'

