-- Delete job
EXEC jobs.sp_delete_job @job_name='AgentJob_SalesOrder_DeltaLoad'
GO
EXEC jobs.sp_add_job @job_name='AgentJob_SalesOrder_DeltaLoad'
GO
-- Add job step for updating table with new or changed rows
EXEC jobs.sp_add_jobstep @job_name='AgentJob_SalesOrder_DeltaLoad',
@command=N'
INSERT INTO salesorder_archive
SELECT 
 [Id]
      ,[SinkCreatedOn]
      ,[SinkModifiedOn]
      ,[statecode]
      ,[statuscode]
      ,[shipto_freighttermscode]
      ,[prioritycode]
      ,[shippingmethodcode]
      ,[paymenttermscode]
      ,[pricingerrorcode]
      ,[vp_handler]
      ,[freighttermscode]
      ,[skippricecalculation]
      ,[vp_distributor]
      ,[vp_newcast]
      ,[ispricelocked]
      ,[willcall]
      ,[owninguser]
      ,[owninguser_entitytype]
      ,[vp_billtocountryid]
      ,[vp_billtocountryid_entitytype]
      ,[modifiedonbehalfby]
      ,[modifiedonbehalfby_entitytype]
      ,[slaid]
      ,[slaid_entitytype]
      ,[owningteam]
      ,[owningteam_entitytype]
      ,[pricelevelid]
      ,[pricelevelid_entitytype]
      ,[slainvokedid]
      ,[slainvokedid_entitytype]
      ,[owningbusinessunit]
      ,[owningbusinessunit_entitytype]
      ,[campaignid]
      ,[campaignid_entitytype]
      ,[accountid]
      ,[accountid_entitytype]
      ,[quoteid]
      ,[quoteid_entitytype]
      ,[transactioncurrencyid]
      ,[transactioncurrencyid_entitytype]
      ,[modifiedby]
      ,[modifiedby_entitytype]
      ,[opportunityid]
      ,[opportunityid_entitytype]
      ,[vp_contactid]
      ,[vp_contactid_entitytype]
      ,[createdby]
      ,[createdby_entitytype]
      ,[contactid]
      ,[contactid_entitytype]
      ,[vp_shiptocountryid]
      ,[vp_shiptocountryid_entitytype]
      ,[createdonbehalfby]
      ,[createdonbehalfby_entitytype]
      ,[vp_salesresponsibleuserid]
      ,[vp_salesresponsibleuserid_entitytype]
      ,[ownerid]
      ,[ownerid_entitytype]
      ,[customerid]
      ,[customerid_entitytype]
      ,[totalamountlessfreight]
      ,[totallineitemdiscountamount]
      ,[freightamount]
      ,[discountamount_base]
      ,[totalamount_base]
      ,[freightamount_base]
      ,[totaltax_base]
      ,[totalamountlessfreight_base]
      ,[totalamount]
      ,[totallineitemamount]
      ,[totaltax]
      ,[discountamount]
      ,[totaldiscountamount]
      ,[totallineitemdiscountamount_base]
      ,[totaldiscountamount_base]
      ,[totallineitemamount_base]
      ,[slaname]
      ,[importsequencenumber]
      ,[customeridyominame]
      ,[vp_purchaseorderdate]
      ,[shipto_line2]
      ,[pricelevelidname]
      ,[shipto_city]
      ,[billto_line2]
      ,[vp_customerspono]
      ,[billto_name]
      ,[createdbyname]
      ,[vp_historydatefullfilled]
      ,[owneridname]
      ,[opportunityidname]
      ,[contactidname]
      ,[vp_shiptocountryidname]
      ,[createdonbehalfbyname]
      ,[salesorderid]
      ,[shipto_stateorprovince]
      ,[vp_salesresponsibleuseridname]
      ,[billto_stateorprovince]
      ,[slainvokedidname]
      ,[shipto_fax]
      ,[emailaddress]
      ,[entityimageid]
      ,[lastbackofficesubmit]
      ,[modifiedbyname]
      ,[name]
      ,[exchangerate]
      ,[entityimage_url]
      ,[contactidyominame]
      ,[versionnumber]
      ,[vp_trackingnumber]
      ,[shipto_postalcode]
      ,[shipto_country]
      ,[modifiedonbehalfbyname]
      ,[vp_contactidyominame]
      ,[billto_city]
      ,[transactioncurrencyidname]
      ,[customeridtype]
      ,[createdon]
      ,[shipto_name]
      ,[overriddencreatedon]
      ,[quoteidname]
      ,[utcconversiontimezonecode]
      ,[vp_salesresponsibleuseridyominame]
      ,[billto_line1]
      ,[createdonbehalfbyyominame]
      ,[billto_telephone]
      ,[ordernumber]
      ,[vp_contactidname]
      ,[submitstatusdescription]
      ,[customeridname]
      ,[entityimage_timestamp]
      ,[processid]
      ,[owneridyominame]
      ,[shipto_addressid]
      ,[createdbyyominame]
      ,[billto_postalcode]
      ,[description]
      ,[billto_fax]
      ,[shipto_line3]
      ,[modifiedon]
      ,[shipto_line1]
      ,[vp_billtocountryidname]
      ,[modifiedbyyominame]
      ,[onholdtime]
      ,[modifiedonbehalfbyyominame]
      ,[shipto_telephone]
      ,[stageid]
      ,[vp_licensename]
      ,[lastonholdtime]
      ,[requestdeliveryby]
      ,[accountidname]
      ,[campaignidname]
      ,[shipto_contactname]
      ,[submitstatus]
      ,[shipto_composite]
      ,[vp_supplier]
      ,[billto_addressid]
      ,[billto_country]
      ,[datefulfilled]
      ,[owneridtype]
      ,[traversedpath]
      ,[discountpercentage]
      ,[billto_contactname]
      ,[timezoneruleversionnumber]
      ,[accountidyominame]
      ,[submitdate]
      ,[billto_line3]
      ,[billto_composite]
        , CAST(GETDATE() as date) [LoadDate]
FROM salesorder
WHERE DATEDIFF(wk,getdate(),modifiedon) = 0
AND YEAR(modifiedon) = YEAR(GETDATE())
;',
@credential_name='job_execution',
@target_group_name='d365Group'
/* Schedule job execution*/   
EXEC jobs.sp_update_job
@job_name='AgentJob_SalesOrder_DeltaLoad',
@enabled=1,
@schedule_interval_type='Weeks',
@schedule_interval_count=1,
@schedule_start_time = '20211002 20:00'